---
title: "STJ2012 analysis"
author: "Ross Cunning"
date: "July 28, 2016"
output: 
  html_document: 
    toc: yes
---

```{r setup, include=FALSE}
knitr::opts_knit$set(root.dir = normalizePath(".."))
knitr::opts_chunk$set(echo = TRUE)

options(scipen = 4, digits = 2)
library(phyloseq); library(vegan); library(multcompView)

taxcolors <- matrix(c(rgb(141, 211, 199, maxColorValue=255), rgb(255, 255, 179, maxColorValue=255), 
                      rgb(190, 186, 218, maxColorValue=255), rgb(251, 128, 114, maxColorValue=255), 
                      rgb(253, 180, 98, maxColorValue=255)), 
                    dimnames=list(c("CladeA", "CladeB", "CladeC", "CladeD", "CladeF")))
```

# Data pre-processing
## Import dataset

```{r data_import, cache=T}
# Import OTU table
OTU <- otu_table(read.table("data/otu_table.tsv", header=T, check.names=F, row.names=1,
                            skip=1, sep="\t", comment.char=""), taxa_are_rows=T)
# Import taxonomy
TAX <- tax_table(as.matrix(read.table("data/tax_assignments.txt", sep="\t", row.names=2,
                                      col.names=c("Clade", "OTU.ID", "Taxonomy", "Eval", "Subtype"))))
# Import sample data
SAM <- sample_data(read.delim("data/mapping_file.txt", sep="\t", header=T, row.names=1))
# Build phyloseq object
phy <- phyloseq(OTU, TAX, SAM)
phy
```

#### Descriptive statistics  
* Total count in OTU table: `r sum(otu_table(phy))`  
* Number of samples: `r nsamples(phy)`  
* Number of OTUs: `r ntaxa(phy)`  

#### Distribution of OTU counts and reads per sample  
```{r phy_histograms, fig.height=2, fig.width=8}
taxhist <- hist(log10(taxa_sums(phy)), plot=F)
samhist <- hist(log10(sample_sums(phy)), plot=F)

par(mfrow=c(1, 2), mar=c(3,3,1,1))
plot(taxhist, col="black", main=NA, xlim=c(0, 5), las=1, mgp=c(2,0.5,0),
     xlab="No. sequences (log10)", ylab="No. OTUs", cex.lab=0.75, cex.axis=0.75)
plot(samhist, col="black", main=NA, xlim=c(0, 5), las=1, mgp=c(2,0.5,0),
     xlab="No. sequences (log10)", ylab="No. samples", cex.lab=0.75, cex.axis=0.75)
```

* Range of OTU counts: `r range(taxa_sums(phy))`  
* Number of singletons:  `r length(taxa_sums(phy)[taxa_sums(phy) <= 1])`  
* Range of reads per sample: `r range(sample_sums(phy))`  
* Mean (±SD) reads per sample (arithmetic): `r mean(sample_sums(phy))` ± `r sd(sample_sums(phy))`  
* Mean (±SD) reads per sample (geometric): `r exp(mean(log(sample_sums(phy))))` ± `r exp(sd(log(sample_sums(phy))))`  

```{r reads_per_sample, fig.height=2, fig.width=8}
plot_bar(phy, x="Sample", y="Abundance")
```

## Filter dataset
#### Filter samples by minimum count
```{r filter_samples}
# Set threshold number of reads
sn <- 10
# Remove samples with fewer reads than threshold
phy.f <- prune_samples(sample_sums(phy)>=sn, phy)
 
```

* Number of samples remaining in dataset: `r nsamples(phy.f) `

#### Filter OTUs by minimum count
```{r filter_taxa}
# Set threshold count
n <- 3
# Identify OTUs below threshold count
taxa <- taxa_sums(phy.f)[which(taxa_sums(phy.f) >= n)]  
# Remove taxa below threshold count
phy.f <- prune_taxa(names(taxa), phy.f)  
```

* Number of OTUs remaining in dataset: `r ntaxa(phy.f)`


#### Descriptive statistics of filtered dataset
* Total count in OTU table: `r sum(otu_table(phy.f))`  
* Number of samples: `r nsamples(phy.f)`  
* Number of OTUs: `r ntaxa(phy.f)` 

#### Distribution of OTU counts and reads of filtered dataset
```{r phy.f_histograms, fig.height=2, fig.width=8}
taxhist <- hist(log10(taxa_sums(phy.f)), plot=F)
samhist <- hist(log10(sample_sums(phy.f)), plot=F)

par(mfrow=c(1, 2), mar=c(3,3,1,1))
plot(taxhist, col="black", main=NA, xlim=c(0, 5), las=1, mgp=c(2,0.5,0),
     xlab="No. sequences (log10)", ylab="No. OTUs", cex.lab=0.75, cex.axis=0.75)
plot(samhist, col="black", main=NA, xlim=c(0, 5), las=1, mgp=c(2,0.5,0),
     xlab="No. sequences (log10)", ylab="No. samples", cex.lab=0.75, cex.axis=0.75)
```

* Range of OTU counts: `r range(taxa_sums(phy.f))`  
* Number of singletons:  `r length(taxa_sums(phy.f)[taxa_sums(phy.f) <= 1])`  
* Range of reads per sample: `r range(sample_sums(phy.f))`  
* Mean (±SD) reads per sample (arithmetic): `r mean(sample_sums(phy.f))` ± `r sd(sample_sums(phy.f))`  
* Mean (±SD) reads per sample (geometric): `r exp(mean(log(sample_sums(phy.f))))` ± `r exp(sd(log(sample_sums(phy.f))))`  

```{r reads_per_sample_filtered, fig.height=2, fig.width=8}
plot_bar(phy.f, x="Sample", y="Abundance")
```

## Transform count data
```{r transform}
# Convert to proportion (relative abundance)
phy.f.p <- transform_sample_counts(phy.f, function(x) x/sum(x))
# Apply transformation function
transform <- function(x) sqrt(x/sum(x))  # Set transformation function
phy.f.t <- transform_sample_counts(phy.f, transform)  # Transform data
```

-----

# Data analysis
## Community composition barplots
Here the composition of each sample is plotted as a horizontal bar, sorted by species and shore. Each segment of the bar represents an individual OTU. In the lefthand plot, all OTUs are colored by clade, in the right OTU, all OTUs are given a unique color.
```{r cladecomp, fig.height=6, fig.width=8}
# Define function to plot Symbiodinium community composition
composition <- function(phy, col, legend=T) {
  samdat <- data.frame(sample_data(phy))
  samdat$Genus <- factor(samdat$Genus, levels=rev(levels(samdat$Genus)))
  samdat$Species <- factor(samdat$Species, levels=rev(levels(samdat$Species)))
  samdat$Shore <- factor(samdat$Shore, levels=rev(levels(samdat$Shore)))
  samdat <- samdat[with(samdat, order(Genus, Species, Shore)), ]
  typerelabund <- as.matrix(otu_table(phy)[order(data.frame(tax_table(phy))$Subtype), 
                                           rownames(samdat)])
  shorebreaks <- c(as.character(samdat$Shore), "X")==c("X", as.character(samdat$Shore))
  shorebreaks <- which(shorebreaks==F) - 1
  spbreaks <- c(which(duplicated(samdat$Species)==F) - 1, nrow(samdat))
  # Make Barplot
  barplot(typerelabund, horiz=T, space=0, axes=F,axisnames=F, yaxs="i", col=col)
  rect(0, 0, par("usr")[2], par("usr")[4], lwd=1, xpd=T)
  axis(side=1, at=seq(0, 1, 0.1), line=0, tck=-0.025, mgp=c(0,0.25,0), cex.axis=0.7)
  mtext(side=1, "Relative abundance", cex=0.7, line=1)
  # Add legend
  if (legend==T) {
    legend(x=par("usr")[2]/2, y=par("usr")[4], xjust=0.5, yjust=0.25, horiz=T, bty="n", xpd=T, 
           cex=0.7, legend=c("A", "B", "C", "D", "F"), fill=taxcolors, x.intersp=0.5)
    legend(x=par("usr")[2]-0.03, y=par("usr")[4], xjust=0, yjust=0.1, bty="n", xpd=T, cex=0.6, 
           pt.cex=0.6, legend=c("N Shore", "S Shore"), fill=c(0, "gray40"), y.intersp=0.7, 
           x.intersp=0.3)
  }
  # Add grouping bars for Shore
  for (i in 1:length(shorebreaks)) {
    lines(c(0, 1), c(shorebreaks[i], shorebreaks[i]), lty=2, lwd=0.25)
    rect(1.01, shorebreaks[i], 1.04, shorebreaks[i+1], col=rep(c("gray40", 0), 50)[i], 
         lwd=0.25, xpd=T)
  }
  # Add lines to separate species and species names
  for (i in 1:length(spbreaks)) {
    lines(c(0, 1.07), c(spbreaks[i], spbreaks[i]), xpd=T, type="l", lwd=0.4)
    text(1.03, (spbreaks[i] + spbreaks[i+1]) / 2, xpd=T, pos=4, cex=0.6,
        labels=paste(samdat$Genus[which(duplicated(samdat$Species)==F)][i], "\n",
                    samdat$Species[which(duplicated(samdat$Species)==F)][i], sep=""))
  }
}

par(mfrow=c(1,2), mar=c(2, 1.5, 2, 5), lwd=0.1, cex=0.7)
composition(phy.f.p, col=taxcolors[data.frame(tax_table(phy.f.p))[order(data.frame(tax_table(phy.f.p))$Subtype), ]$Clade], legend=T)
composition(phy.f.p, col=rainbow(ntaxa(phy.f.p)), legend=F)

```

## Differences between species and shores
Whether *Symbiodinium* communities differ among species, or differ between north vs. south shores within species, is evaluated here using permutational analysis of variance (PERMANOVA).

```{r permanovas, cache=T}
# PERMANOVA for differences among species? Post-hoc: which spp are different?

permanova.spp.t <- adonis(phyloseq::distance(phy.f.t, "bray") ~ Species, 
                          data=as(sample_data(phy.f.t), "data.frame"), permutations=9999)

dmat <- as(phyloseq::distance(phy.f.t, "bray"), "matrix")
df <- as(sample_data(phy.f.t), "data.frame")


pairs <- data.frame(t(combn(levels(df$Species), 2)), stringsAsFactors=F)
p.pairs <- setNames(rep(NA, nrow(pairs)), with(pairs, paste(X1, X2, sep='-')))

for (i in 1:nrow(pairs)) {
  dfs <- subset(df, Species %in% c(pairs[i,1], pairs[i,2]))
  dmats <- dmat[rownames(dfs), rownames(dfs)]
  set.seed(152470)
  permanova <- adonis(dmats ~ Species, data=dfs, permutations=999)
  p.pairs[i] <- permanova$aov.tab$`Pr(>F)`[1]
}

multcompLetters(p.pairs)


# Compute within- and between-pool statistics for each Species
shorestats <- data.frame(matrix(dimnames=list(levels(data.frame(sample_data(phy.f.t))$Species), 
                                              c("Species", "n", "overall", "within", 
                                                "between", "R2", "bd", "p")), ncol=8, nrow=10))
for (i in 1:nlevels(data.frame(sample_data(phy.f.t))$Species)) {
  sp <- levels(data.frame(sample_data(phy.f.t))$Species)[i]
  shorestats$Species[i] <- sp
  phy.f.t.species <- subset_samples(phy.f.t, Species==sp)  # Set temp phyloseq object
  shorestats$n[i] <- nsamples(phy.f.t.species)
  md <- meandist(phyloseq::distance(phy.f.t.species, "bray"), 
                 sample_data(phy.f.t.species)$Shore)
  shorestats$within[i] <- summary(md)$W  # Weighted mean dissimilarity within both Pools
  shorestats$between[i] <- summary(md)$B  # Mean dissimilarity between Pools
  shorestats$overall[i] <- summary(md)$D  # Overall dissimilarity
  if (nlevels(as(sample_data(phy.f.t.species), "data.frame")$Shore) > 1) {
    set.seed(70235)
    permanova <- adonis(phyloseq::distance(phy.f.t.species, "bray") ~ Shore, 
                        data=as(sample_data(phy.f.t.species), "data.frame"), permutations=999)
    shorestats$R2[i] <- permanova$aov.tab$"R2"[1]  # PERMANOVA partial R-squared
    shorestats$p[i] <- permanova$aov.tab$"Pr(>F)"[1]  # PERMANOVA p-value
    bd <- betadisper(phyloseq::distance(phy.f.t.species, "bray"),
                     group=as(sample_data(phy.f.t.species), "data.frame")$Shore)
    shorestats$bd[i] <- TukeyHSD(bd)$group[4]
  } else {
    shorestats$R2[i] <- NA
    shorestats$p[i] <- NA
    shorestats$bd[i] <- NA
  }
}
knitr::kable(shorestats)  # dendrogyra, porites furcata, and siderastrea siderea differ by shore
```

## Beta diversity
Beta diversity is evaluated here as the multivariate dispersion of samples within a coral species group. Principal coordinate analysis on Bray-Curtis dissimilarities is used to calculate average distance-to-centroid values for each species group, which are then compared statistically by a permutation test. This analysis is implemented using betadisper() in the vegan package, based on [Anderson (2006)](dx.doi.org/10.1111/j.1541-0420.2005.00440.x).
```{r betadisper, cache=T, fig.width=4, fig.height=4}
# Calculate distances to species centroids for each sample in principal coordinate space
sambd <- betadisper(d=vegdist(t(otu_table(phy.f.t)), method="bray"), 
                    group=data.frame(sample_data(phy.f.t))$Species, type="centroid",
                    bias.adjust=TRUE)
# Calculate each species' mean distance to centroid and standard error
sambdsumm <- aggregate(data.frame(mean=sambd$distances), by=list(group=sambd$group), FUN=mean)
sambdsumm$se <- aggregate(sambd$distances, by=list(group=sambd$group), 
                      FUN=function(x) sd(x)/sqrt(length(x)))$x
# Determine order of decreasing mean dispersion
sambdsumm.ord <- sambdsumm[order(sambdsumm$mean, decreasing=T), ]
# Update betadisper object with species in decreasing order of mean dispersion
sambd <- betadisper(d=vegdist(t(otu_table(phy.f.t)), method="bray"), 
                    group=factor(data.frame(sample_data(phy.f.t))$Species, levels=as.character(sambdsumm.ord$group)), type="centroid", bias.adjust=TRUE)
# Use permutations to perform pairwise comparisons of group mean dispersions
sampt <- permutest(sambd, pairwise=T)
saml <- multcompLetters(sampt$pairwise$permuted)

# Figure: Distance to centroids
par(mfrow=c(1,1), mar=c(3.5,4,1,1), lwd=1)
with(sambdsumm.ord, {
  plot(mean, type="n", ylim=c(0, 0.75), ylab="Distance to centroid", xaxt="n", xlab="")
  arrows(1:10, mean - se, 1:10, mean + se, length=0.05, angle=90, code=3)
  points(1:10, mean, cex=1, pch=21, bg="white")
  text(1:10, par("usr")[3]-0.025, srt=45, adj=1, xpd=T, cex=0.75, 
       labels=levels(SAM$Species)[order(sambdsumm$mean, decreasing=T)])
  text(1:10, mean + se + 0.03, labels=saml$Letters[as.character(group)], cex=0.5)
})
```

```{r strigosa}
dstr <- subset_samples(phy.f.p, Species=="strigosa")
plot_bar(dstr, x="Sample", y="Abundance", fill="OTU")
plot_bar(dstr, x="Sample", y="Abundance", fill="Subtype")
# D strigosa hosted B1, B24, B35, B38, and C3 in Finney et al.... B25, B35, and B38 are missing from ref database.
# Also try 100% OTUs
```

## Niche breadth of *Symbiodinium*
```{r nichebreadth}
# Mean dispersion of clades
otubd <- betadisper(d=vegdist(otu_table(phy.f.t), method="bray"), 
                    group=data.frame(tax_table(phy.f.t))$Clade, type="centroid")
otubd

# Number of samples each OTU appears in
nsamp <- data.frame(n=rowSums(otu_table(phy.f.t) != 0))
nsamp$Subtype <- data.frame(tax_table(phy.f.t))[rownames(nsamp), "Subtype"]
nsamp[order(nsamp$n, decreasing=T), ]
nsamp
?order

```

plot_richness(phy.f, x="Species")
    